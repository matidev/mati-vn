/**
 * @author Tien Mai (matidev@outlook.com)
 * @version 1.0
 */

jQuery(function ($) {
  var $amlichForm = $('#mati-amlich'),
    $amlichEvents = $amlichForm.find('#mati-al-events'),
    $amlichNewLine = $amlichForm.find('#mati-al-newline'),
    newLineId = 0,
    newLineTpl = function (id) {
      var randomId = (new Date()).getTime();
      id = typeof id === 'number' ? parseInt(id) : 1;

      return '<tr class="event-item">\n' +
        '  <td class="text-center align-middle small item-id">' + id + '</td>' +
        '  <td class="text-center align-middle">\n' +
        '    <div class="form-group form-control-sm">\n' +
        '      <label for="event-name-' + randomId + '" class="sr-only"></label>\n' +
        '      <input type="text" class="form-control event-name" id="event-name-' + randomId + '">\n' +
        '    </div>\n' +
        '  </td>\n' +
        '  <td class="text-center align-middle">\n' +
        '    <div class="form-group form-control-sm mx-auto" style="max-width: 250px">\n' +
        '      <label for="event-date-' + randomId + '" class="sr-only"></label>\n' +
        '      <input type="date" class="form-control event-date" id="event-date-' + randomId + '">\n' +
        '    </div>\n' +
        '  </td>\n' +
        '  <td class="text-center align-middle">\n' +
        '    <div class="form-check form-check-inline">\n' +
        '      <input type="checkbox" class="form-check-input event-is-lunar" id="event-is-lunar-' + randomId + '" checked>\n' +
        '      <label for="event-is-lunar-' + randomId + '" class="form-check-label sr-only">Sự kiện là ngày âm?</label>\n' +
        '    </div>\n' +
        '  </td>\n' +
        '  <td class="text-center align-middle">\n' +
        '    <button type="button" class="btn btn-danger btn-sm btn-al-delete"><i class="fa-solid fa-trash-can"></i></button>\n' +
        '  </td>\n' +
        '</tr>'
    },
    getTimezone = function () {
      return new Date().getTimezoneOffset() / -60;
    },
    getEventDate = function (dd, mm, yyyy, isLunar) {
      if (!isLunar) {
        return [dd, mm, yyyy];
      }

      var solarDate = convertLunar2Solar(dd, mm, yyyy, 0, getTimezone()),
        lunarDate = convertSolar2Lunar(solarDate[0], solarDate[1], solarDate[2], getTimezone());

      if (lunarDate[0] === dd && lunarDate[1] === mm && lunarDate[2] === yyyy) {
        return solarDate;
      }

      return convertLunar2Solar(dd, mm, yyyy, 1, getTimezone());
    },
    getTodaySolar = function () {
      var today = new Date(),
        day = today.getDate(),
        month = today.getMonth() + 1,
        year = today.getFullYear();

      return (day < 10 ? '0' + day : day) + '/' + (month < 10 ? '0' + month : month) + '/' + year;
    },
    getTodayLunar = function () {
      var today = new Date(),
        lunar = convertSolar2Lunar(today.getDate(), today.getMonth() + 1, today.getFullYear(), getTimezone()),
        day = parseInt(lunar[0]),
        month = parseInt(lunar[1]),
        year = parseInt(lunar[2]);

      return (day < 10 ? '0' + day : day) + '/' + (month < 10 ? '0' + month : month) + '/' + year;
    },
    countLines = function () {
      var count = $amlichEvents.find('tr').length;

      return typeof count !== 'undefined' ? (count + 1) : 1;
    }
  ;

  $('#mati-al-today-solar').html(getTodaySolar());
  $('#mati-al-today-lunar').html(getTodayLunar());

  if ($amlichForm.length) {
    $amlichEvents.append(newLineTpl(1));

    $amlichNewLine.on('click', function () {
      var item = $(newLineTpl(countLines())).hide();
      $amlichEvents.append(item);
      item.fadeIn(1000);
      item.find('.event-name').focus();
    });

    $amlichForm.on('submit', function (e) {
      e.preventDefault();

      var $events = $amlichEvents.find('tr'),
        downloadReady = true,
        cal = ics();

      if ($events.length < 1) {
        downloadReady = false;
      }

      $.each($events, function (idx, el) {
        var $el = $(el),
          name = $(el).find('.event-name').val(),
          date = $(el).find('.event-date').val(),
          isLunar = $(el).find('.event-is-lunar').is(':checked');

        if (date.length && name.length) {
          var solarDate = new Date(date),
            startYear = solarDate.getFullYear(),
            endYear = startYear + 25;

          for (var year = startYear; year <= endYear; year++) {
            var eventDate = getEventDate(solarDate.getDate(), solarDate.getMonth() + 1, year, isLunar),
              eventStart = eventDate[1] + '/' + eventDate[0] + '/' + eventDate[2] + ' 08:00:00';

            cal.addEvent(name, 'Created by MATI Âm Lịch (https://mati.vn/am-lich)', '', eventStart, eventStart);
          }
        } else {
          if (date.length < 1) {
            $(el).find('.event-date').addClass('error');
          }

          if (name.length < 1) {
            $(el).find('.event-name').addClass('error');
          }

          downloadReady = false;
        }
      });

      if (downloadReady) {
        cal.download('mati-vn-am-lich');
      }
    });

    $(document).on('click', '.btn-al-delete', function () {
      $(this).closest('tr.event-item').fadeOut(500, function () {
        $(this).remove();

        $amlichEvents.find('tr').each(function (idx, el) {
          $(el).find('.item-id').html(idx + 1);
        });
      });
    });

    $(document).on('change keyup', 'input.form-control', function () {
      var $that = $(this);
      $that.toggleClass('error', $that.val().length < 1);
    });
  }
});
